<!DOCTYPE HTML>
<html>
<head>
<title>climber</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="js/jquery.mobile.js"></script>
<link rel="stylesheet" type="text/css" href="css/jquery.mobile.css" />
<link rel="stylesheet" type="text/css" href="css/jquery.mobile.structure.css" />
<link rel="stylesheet" type="text/css" href="css/jquery.mobile.theme.css" />
<script type="text/javascript" charset="utf-8" src="js/phonegap.js"></script>

<!-- foreground camera for android background closing bug -->
<script type="text/javascript" src="js/camera.js"></script>

<!-- if android version <3.0 -->
<script type="text/javascript" charset="utf-8" src="js/todataurl.js"></script>

<!-- mapping apis -->
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="js/jquery.ui.map/jquery.ui.map.js"></script>
<script type="text/javascript" src="js/jquery.ui.map/jquery.ui.map.services.js"></script>
<style>
</style>

<!--  setup climbing image behaviour  -->
<script type="text/javascript" charset="utf-8" src="js/climage.js"></script>
<script type="text/javascript" charset="utf-8" src="js/rest.js"></script>
<script type="text/javascript">
var currentClimage; 

// MAPPING
var currentMap;
function centreToLocation(latitude, longitude, zoom) {
	var mapOptions = {
		zoom: zoom,
		streetViewControl : false,
		center: new google.maps.LatLng(latitude, longitude),
		mapTypeId: google.maps.MapTypeId.ROADMAP
	}
	currentMap = new google.maps.Map($('#map-square')[0], mapOptions);
}
function addArea(latitude, longitude, areaId) {
	var marker = new google.maps.Marker({
		position: new google.maps.LatLng(latitude, longitude),
		map: currentMap,
		title:"Hello World!"
	});
	google.maps.event.addListener(marker,'click', function() {
		centreToLocation(marker.position.Ya, marker.position.Za, currentClimage.areaZoom)
		markAreaRoutes(areaId)
	});
}
function addRoute(latitude, longitude, routeId) {
	var marker = new google.maps.Marker({
		position: new google.maps.LatLng(latitude, longitude),
		map: currentMap,
		title:"Hello World!"
	});
	google.maps.event.addListener(marker,'click', function() {
		$.mobile.changePage('#route')
		getRoute(routeId)
	});
}
function updateLocation() {
	navigator.geolocation.getCurrentPosition(
		function(position) {
			currentClimage.latitude = position.coords.latitude
			currentClimage.longitude = position.coords.longitude
			centreToLocation(currentClimage.latitude, currentClimage.longitude, currentClimage.globalZoom)
			$('#latitude').val(position.coords.latitude)
			$('#longitude').val(position.coords.longitude)
//  			alert('Latitude: '		  + position.coords.latitude		  + '\n' +
//  				  'Longitude: '		 + position.coords.longitude		 + '\n' +
//  				  'Accuracy: '		  + position.coords.accuracy		  + '\n' +
		}, function(error) {  alert('code: '	+ error.code	+ '\n' +
				  'message: ' + error.message + '\n'); },
		{ maximumAge: 60000, timeout: 30000, enableHighAccuracy: true }
	);
}

// get routes at the tapped climbing site
function markAreaRoutes(areaId) {
	$.getJSON('http://'+server+'/api/route/getAreaRoutes/'+areaId, function(data) {
		$(data).each(function() {
			addRoute($(this).attr('latitude'), $(this).attr('longitude'), $(this).attr('id'))
		})
	})
}
// get climbing sites and place markers on the map denoting them
function markSitesNear(latitude, longitude) {
	$.getJSON('http://'+server+'/api/route/getAreas', function(data) {
		$(data).each(function() {
			addArea($(this).attr('latitude'), $(this).attr('longitude'), $(this).attr('id'))
		})
	})
}
function resetMap() {
	updateLocation()
	centreToLocation(currentClimage.latitude, currentClimage.longitude, currentClimage.globalZoom)
	markSitesNear(currentClimage.latitude, currentClimage.longitude)
}


// stretch the footer to the bottom of the page [1. get rid of padding (prevents jerky adjustment) or 2. adjust for padding (keeps padding for nice inner layout)]
$(window).delegate('.content-adjust-no-padding', 'pageshow', function () {
	$(this).find('[data-role="content"]').css('padding','0px'); // override the padding for the content so things don't overflow
	var the_height = ($(window).height() - $(this).find('[data-role="header"]').height() - $(this).find('[data-role="footer"]').height())
    $(this).height($(window).height()).find('[data-role="content"]').height(the_height)
	var the_width = $(window).width();
    $(this).width($(window).width()).find('[data-role="content"]').width(the_width);
});
$(window).delegate('.content-adjust-for-padding', 'pageshow', function () {
	var contentVerticalPadding = parseInt($(this).find('[data-role="content"]').css('padding-left'))+parseInt($(this).find('[data-role="content"]').css('padding-right'))
	var the_height = ($(window).height() - $(this).find('[data-role="header"]').height() - $(this).find('[data-role="footer"]').height())
    $(this).height($(window).height()).find('[data-role="content"]').height(the_height-contentVerticalPadding)
    
	var contentHorizontalPadding = parseInt($(this).find('[data-role="content"]').css('padding-top'))+parseInt($(this).find('[data-role="content"]').css('padding-bottom'))
	var the_width = $(window).width();
    $(this).width($(window).width()).find('[data-role="content"]').width(the_width-contentHorizontalPadding);
});

$(document).bind('pageinit',function(event) { 
	currentClimage = new Climage(); 
	$('#canvas').click(function(e) { 
		currentClimage.addRoutePoint(e.clientX-$("#canvas").offset().left, e.clientY-$("#canvas").offset().top); 
	}) 
	$('#routeSelector').change(function() { 
		getRoute($('#routeSelector option:selected').val()) 
	})
}); 

//$(document).bind('deviceready',function() {
$(document).bind('ready',function() {
	resetMap()
});
</script>


</head>
<body>

	<div data-role="page" id="map" class="content-adjust-no-padding">
		<div data-role="header" id="map-header">
			<div data-role="navbar">
				<ul>
					<li><a href="#home">Home</a></li>
					<li><a href="#map" class="ui-btn-active">Map</a></li>
					<li><a href="#route">Route</a></li>
				</ul>
			</div>		
		</div>
		<div data-role="content" id="map-square"></div>
		<div data-role="footer" id="map-footer">
			<div data-role="navbar">
				<ul>
					<li><a onclick="resetMap()">Reset</a></li>
				</ul>
			</div>
		</div>		
	</div>


	<div data-role="page" id="home" class="content-adjust-for-padding">
		<div data-role="header">
			<div data-role="navbar">
				<ul>
					<li><a href="#home" class="ui-btn-active">Home</a></li>
					<li><a href="#map">Map</a></li>
					<li><a href="#route">Route</a></li>
				</ul>
			</div>
		</div>
		<div data-role="content">
			<p>like whatever</p>
		</div>
		<div data-role="footer">
		</div>
	</div>


	<div data-role="page" id="route" class="content-adjust-for-padding">
		<div data-role="header">
			<div data-role="navbar">
				<ul>
					<li><a href="#home">Home</a></li>
					<li><a href="#map">Map</a></li>
					<li><a href="#route" class="ui-btn-active">Route</a></li>
				</ul>
			</div>		
		</div>
		<div data-role="content">
			<canvas width="300" height="200" id="canvas" style="border:1px solid black;"></canvas>
			<input type="text" id="latitude" value="53" />
			<input type="text" id="longitude" value="0" />
			<input type="text" id="routeName" value="a route" />
			<div id="output"></div>
		</div>
		<div data-role="footer">
			<div data-role="navbar">
				<ul>
					<li><a onclick="postClimage()">Save</a></li>
					<li><a onclick="currentClimage.takePhoto()">Take Photo</a></li>
				</ul>
			</div>
		</div>		
	</div>

</body>
</html>
